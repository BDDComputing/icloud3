# iCloud3 Change Log

#### v2.0.6 (Under Development, Not Released, Last Updated 2/20/2020)

- Device Tracking:

    - In some cases, no contact data was being returned from the iCloud Find-my-Friends Service. Because of this, iCloud3 could not match the email address on the tracked devices parameter with the iCloud contacts and no devices would  be tracked. Now, if this occurs, a secondary source of contact identification will be used and the device will be tracked. However, the Contact's First Name is not available in this secondary data source so it should be specified on the track_devices configuration parameter (see next item).
    - You can now specify the person's name associated with the device on the track_devices configuration parameter. If you don't specify it, the name is extracted from the devicename by removing the device type (iPhone, iPad, etc) and any special characters. That name is then displayed on the iCloud3 Event Log card and on other messages generated by iCloud3. This has nothing to do with the HA Person entity.
    - The Entity Registry is read when iCloud3 is started to extract the iOS App entities to be monitored. The directory location of the Entity Registry is now retrieved from HA rather than being hard coded in iCloud3. This can still be overridden using the 'entity_registry_file_name' configuration parameter.
    - If there was an iCloud authorization error 5-times, the tracking method is reset from fmf/famshr to IOSAPP. If iCloud3 was then restarted, the IOSAPP tracking method would still be used after the restart instead of being reset to the configuration file tracking method (fmf/famshr). This has been corrected.
    - Added a 'log_level: debug+rawdata' configuration parameter that will dump the raw iCloud data into the HA log file as it is returned by pyicloud_ic3. The `log_level: debug` statement will continue to add general debug information to the HA log file.

- Stationary Zone:

    - The Stationary Zone is now set up the first time it is needed rather than when iCloud3 starts. This solves the problem of HA Map and Zone Configuration screens being completely zoomed out to show the default Stationary Zone location at the North Pole.
    - The Stationary Zone is no longer hidden when you leave it but still shows on the HA Map screen. It's radius is reduced to 10 meters and will be reset to 2 times the Home Zone radius when it is needed again.
    - Since each device can have its own Stationary Zone, the device's icon is now the first letter of the Friendly Name associated with the device. It is displayed on different backgrounds if there is more than one device with the same first initial. The first background displayed is a filled-box, followed by a filled-circle, an outlined-box, an outlined-circle, and the initial itself.

- iCloud3 Sensor Changes:

    - Added the `sensor.name` sensor that displays the person's name associated with the device. It can be included or excluded using the 'name' sensor code.
    - The `Sensor Name Prefix` parameter on the tracked_device configuration line has been removed. The devicename is now used at the beginning of the sensors created by iCloud3.
    - Added the Battery Status ('batstat') and Badge ('badge') codes to the create_sensors and exclude_sensors list.

- PyiCloud-ic3.py Support Program Changes (Interface between iCloud3 and Apple's iCloud Location Services)

    - PyiCloud_ic3.py (the iCloud Location Services interface module) will now display raw data for all data requests. To display this information, include the `custom_components.icloud3.pyicloud_ic3`: debug  statement in the `logger: /logs:`  section of the HA configuration.yaml file. For example:
      
        `
        
        ```
        logger:
              default: info
              logs:
                custom_components.icloud3.pyicloud_ic3
        ```
        
        `
        
    - pyicloud_ic3 cookie file used to store Apple iCloud cookies file location was changed from /config/icloud to /config/.storage/icloud. This is the same location used by the HA Apple iCloud integration. The iCloud3 authentication cookies will now be shared if the iCloud Integration is installed. This may generate a one-time notification from Apple about a new account login.

- iCloud3 Event Log Card and Lovelace 

    - The picture specified on the track_devices parameter was only being displayed on the Lovelace card if the device was specified in the `known_devices.yaml` file. The `entity_picture` attribute was added to the device_tracker entity (e.g., `device_tracker.gary_iphone`) so it would always be displayed.
    - Fixed the Lovelace documentation error for the 4x3 layout.
    - The Event Log message is now being verified to make sure it is not blank.
    - Cleaned up some event and error messages.

    

#### v2.0.5 (12/8/2019)

- Fixed a bug introduced in v2.0.4 where a coding error caused NoRoute information to be returned from Waze.
- Added GPS location to Stationary Zone Set Location Event Log message.
- Reset the Stationary Zone to it's base location (90, 180) when an update is being done, the device is in a non-Stationary zone and the Stationary Zone is set to a valid location.
- Raw contact data from the 'username' non-2fa iCloud account will be added to the HA log file when setting up the FmF tracking method. Add the 'log_level: debug' parameter to the iCloud3 configuration and restart HA. Go to 'Sidebar>Developer Tools>Logs' to see the Log entries. Look for "_____ Raw iCloud Contact Data _______" and review the raw data for each contact on the following line. It will be in json format, e.g., 'emails': ['gary_2fa_acct@email.com', 'gary_456@tw'].

#### v2.0.4 (11/29/2019)
- When the device's location, interval and next poll information were being updated, there were times when the state was 'stationary' but it had actualy moved into another zone. This might be caused by zones being close together, by no zone exit notification from the ios app or by the next update trigger being processed before the zone exit trigger had been received. This caused the device's location to be reset to the old location instead of the new location. This has been fixed.
- Waze history data is used to avoid calling Waze for route information when you are near another device or in a stationary zone with accurate Waze route information. If you were in a stationary zone and entered another zone without a zone exit trigger, the Waze history was still pointing to the old stationary zone. The old location information was being used for distance and interval calculations instead of the new location information.  A check was added to always refresh the Waze route information when the state changes.
- Made some corrections to the iCloud3 documentation.

#### v2.0.3 (11/27/2019)

- Fixed a problem with a malformed message that displayed old location information in the Event Log.
- Added a list of devices that are tracked and not tracked for the Family Sharing (famshr) tracking method. This is creaed when the iCloud account is scanned looking for the devices in the `track_devices` configuration parameter.

#### v2.0.2 (11/27/2019)

- Fixed problem calculating distance and intervals for a second zone.
- Reformatted some Event Log messages.

#### v2.0.1 (11/26/2019)

- If no location data was available while calculating the distance from Home using Waze, iCloud3 would go into an error correction loop and hang up. This has been corrected.
- If the a location request was made using the icloud3_update service and the notify.mobile_app_devicename service was not available, an unformatted error would be added to the HA log file that did not correctly explain the error. A friendly error message better explaining the problem is now added to the Event Log and HA log file.
- Stationary zone location information was not being refreshed correctly on subsequent polls. It was showing as (None, None) in the HA log file and may have generated an error message or used the wrong location when moving back to the center of the stationary zone. This has been corrected.
- Using the FamShr tracking method generated an 'IndexError: tuple index out of range' error message and would not iCloud3 load. This has been corrected.
- Additional error checking has been added to recover from situations when no location information was available when calculating the distance moved from the last location to the current location. If this happens, the distance moved will be 0 km.
- The 'manifest.json' file was pointing to wrong GitHub repository.
- Changed the 'pyicloud_ic3.py' version to 1.0.

---

A comprehensive list of all of the new features and enhancements for iCloud3 v2.0 is in the Change Log in the iCloud3 Documentatiioon.



[![button_documentation](docs/images/button_documentation.jpg)](https://gcobb321.github.io/icloud3/#/)

[![button_download_long](docs/images/button_download_long.jpg)](https://github.com/gcobb321/icloud3/releases)

[![button_github](docs/images/button_github.jpg)](https://github.com/gcobb321/icloud3)


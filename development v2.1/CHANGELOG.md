# iCloud3 Change Log

#### v2.1 (2/10/2020) - Release Candidate

- Device Tracking:

    - In some cases, no contact data was being returned from the iCloud Find-my-Friends Service. Because of this, iCloud3 could not match the email address on the tracked devices parameter with the iCloud contacts and no devices would  be tracked. Now, if this occurs, a secondary source of contact identification will be used and the device will be tracked. However, the Contact's First Name is not available in this secondary data source so it should be specified on the track_devices configuration parameter (see next item).
    - You can now specify the user's name associated with the device on the track_devices configuration parameter. If you don't specify it, the name is extracted from the devicename by removing the device type (iPhone, iPad, etc) and any special characters. That name is then displayed on the iCloud3 Event Log card and on other messages generated by iCloud3. This has nothing to do with the HA Person entity.
    - The Entity Registry is read when iCloud3 is started to extract the iOS App entities to be monitored. The directory location of the Entity Registry is now retrieved from HA rather than being hard coded in iCloud3. This can still be overridden using the 'entity_registry_file_name' configuration parameter.
    - If there was an iCloud authorization error 5-times, the tracking method is reset from fmf/famshr to IOSAPP. If iCloud3 was then restarted, the IOSAPP tracking method would still be used after the restart instead of being reset to the configuration file tracking method (fmf/famshr). This has been corrected.
    - Added a 'log_level: debug+rawdata' configuration parameter that will dump the raw iCloud data into the HA log file as it is returned by pyicloud_ic3. The `log_level: debug` statement will continue to add general debug information to the HA log file.

- Stationary Zone:

    - The Stationary Zone is now set up the first time it is needed rather than when iCloud3 starts. This solves the problem of HA Map and Zone Configuration screens being completely zoomed out to show the default Stationary Zone location at the North Pole.
    - The initial Stationary Zone location is about .5km north or south of your Home zone depending on whether you are north or south of the equator.
    - Fixed some issues where the device location was changed to the Stationary Zone or a previous location when it should not have been.
    - The Stationary Zone is no longer hidden when you leave it but still shows on the HA Map screen. It's radius is reduced to 3 meters and will be reset to 2 times the Home Zone radius when it is needed again.
    - When you are in a Stationary Zone, the zone location will be changed to your current GPS coordinates rather then changing your GPS coordinates to the original location of the Stationary Zone. In other words, the Stationary Zone will move with you.
    - Since each device can have its own Stationary Zone, the device's icon is now the first letter of the Friendly Name associated with the device. It is displayed on different backgrounds if there is more than one device with the same first initial. The first background displayed is a filled-box, followed by a filled-circle, an outlined-box, an outlined-circle, and the initial itself.
    - The iOS App does not load new zone information when zones are created or changed. Since the Stationary Zone is recreated every time iCloud3 starts, there may be times when the iOS App does not issue an Exit Trigger when you leave the Stationary Zone. If this occurs, a message is sent to the device to force close the iOS App via the App Switcher and then restart it to load the zone information again.  As a side note, if you manually create the Stationary Zone using the Configuration/Zones screen or the `zone.yaml` configuration file, HA will then own the zone and iCloud3 will not be able to change it's location, so you do not want to do that.

- iCloud3 Sensor Changes:

    - Added the `sensor.name` sensor that displays the person's name associated with the device. It can be included or excluded using the 'name' sensor code.
    - The `Sensor Name Prefix` parameter on the tracked_device configuration line has been removed. The devicename is now used at the beginning of the sensors created by iCloud3.
    - Added the Battery Status ('batstat') and Badge ('badge') codes to the create_sensors and exclude_sensors list.

- PyiCloud-ic3.py Support Program Changes (Interface between iCloud3 and Apple's iCloud Location Services)

    - PyiCloud_ic3.py (the iCloud Location Services interface module) will now display raw data for all data requests. To display this information, include the `custom_components.icloud3.pyicloud_ic3`: debug  statement in the `logger: /logs:`  section of the HA configuration.yaml file. For example:
      
        `
        
        ```
        logger:
              default: info
              logs:
                custom_components.icloud3.pyicloud_ic3
        ```
        
        `
        
    - pyicloud_ic3 cookie file used to store Apple iCloud cookies file location was changed from /config/icloud to /config/.storage/icloud. This is the same location used by the HA Apple iCloud integration. The iCloud3 authentication cookies will now be shared if the iCloud Integration is installed. This may generate a one-time notification from Apple about a new account login.

- iCloud3 Event Log Card and Lovelace 

    - Changed the look of the Event Log Card to better highlight a complete location update from when it started to when it completed. 
    - Added a lot of information to the Event Log as location, trigger and zone events take place to make it easier to see why things happen the way they do.
    - Added Debug and Restart-iC3 buttons to be able to turn on and turn off debug logging. All debug messages that were being added to the HA log are now added to the Event Log. You can also restart iCloud3 to see initialization errors or to reauthenticate the iCloud account. Although changes to the configuration parameters are not reloaded, zone changes are reloaded.
    - The picture specified on the track_devices parameter was only being displayed on the Lovelace card if the device was specified in the `known_devices.yaml` file. The `entity_picture` attribute was added to the device_tracker entity (e.g., `device_tracker.gary_iphone`) so it would always be displayed.
- Fixed the Lovelace documentation error for the 4x3 layout.
    - The Event Log message is now being verified to make sure it is not blank.
    - Cleaned up some event and error messages.
    
    

---

A comprehensive list of all of the new features and enhancements for iCloud3 v2.1 is in the Change Log in the iCloud3 Documentatiioon.



[![button_documentation](docs/images/button_documentation.jpg)](https://gcobb321.github.io/icloud3/#/)

[![button_download_long](docs/images/button_download_long.jpg)](https://github.com/gcobb321/icloud3/releases)

[![button_github](docs/images/button_github.jpg)](https://github.com/gcobb321/icloud3)

